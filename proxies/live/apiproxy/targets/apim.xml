<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<TargetEndpoint name="apim">
    <PreFlow name="PreFlow">
        <Request>
            <Step>
                <Name>OAuthV2.VerifyAccessToken</Name>
            </Step>
            <Step>
                <Name>AssignMessage.RenameQuotaVars</Name>
            </Step>
            <Step>
                <Name>Quota</Name>
            </Step>
            <Step>
                <Name>SpikeArrest</Name>
            </Step>
            <Step>
              <Name>VerifyAPIKey.CustomAttributes</Name>
            </Step>
            <Step>
                <Name>RaiseFault.Invalid-X-Request-Id</Name>
                <Condition>(request.header.X-Request-ID == null) or (not request.header.X-Request-ID ~~ "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$")</Condition>
            </Step>
            <Step>
                <Name>RaiseFault.Invalid-NHSD-Session-URID</Name>
                <Condition>request.header.NHSD-Session-URID = null or request.header.NHSD-Session-URID = ""</Condition>
            </Step>
            <Step>
                <Name>RaiseFault.Invalid-Content-Type</Name>
                <Condition>request.verb != "GET" and request.header.content-type != "application/fhir+json"</Condition>
            </Step>
            <Step>
                <Name>RaiseFault.InvalidPayload</Name>
                <Condition>request.verb != "GET" and request.content = ""</Condition>
            </Step>
            <Step>
              <Name>RaiseFault.MissingASID</Name>
                <Condition>verifyapikey.VerifyAPIKey.CustomAttributes.asid is null</Condition>
            </Step>
            <Step>
              <Name>RaiseFault.MissingODS</Name>
              <Condition>verifyapikey.VerifyAPIKey.CustomAttributes.ods is null</Condition>
            </Step>
            <Step>
              <Name>KeyValueMapOperations.GetSecureVariables</Name>
            </Step>
            <Step>
              <Name>JavaScript.CreateClaimVars</Name>
            </Step>
            <Step>
              <Name>AssignMessage.RemoveHeaders</Name>
            </Step>
            <Step>
              <Name>AssignMessage.JWT</Name>
            </Step>
            <Step>
              <Name>AssignMessage.AddHeaders</Name>
            </Step>
        </Request>
        <Response>
            <Step>
                <Name>AssignMessage.AddCors</Name>
            </Step>
        </Response>
    </PreFlow>
    <HTTPTargetConnection>
        <Properties>
            <!-- Whitelist the 'expected' error code responses so the responses pass unhindered to caller
                 Anything unexpected will be sanitsed by the DefaultFaultRule -
                 https://docs.apigee.com/api-platform/fundamentals/fault-handling#customhandlingofhttperrorcodesfromthetargetserver -->
            <Property name="success.codes">1xx,2xx,3xx,4xx</Property>
        </Properties>
        <SSLInfo>
            <Enabled>true</Enabled>
        </SSLInfo>
        <URL>https://{{ APIM_PROXY_HOSTNAME }}</URL>
    </HTTPTargetConnection>
    <FaultRules>
        <FaultRule name="InvalidAccessToken">
            <Condition>oauthV2.OAuthV2.VerifyAccessToken.failed</Condition>
            <Step>
                <Name>ExtractVariables.InvalidAccessToken</Name>
            </Step>
            <Step>
                <Name>AssignMessage.InvalidAccessToken</Name>
            </Step>
        </FaultRule>
        <FaultRule name="JWTGenerationError">
            <Condition>JWT.failed = true</Condition>
            <Step>
                <Name>AssignMessage.JWTGenerationError</Name>
            </Step>
        </FaultRule>
        <DefaultFaultRule name="UnkownError">
            <Step>
                <Name>AssignMessage.CatchAllErrorMessage</Name>
            </Step>
        </DefaultFaultRule>
    </FaultRules>
</TargetEndpoint>
